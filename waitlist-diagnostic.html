<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adworthâ„  â€” Waitlist Form Diagnostic</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --green-deep: #1a4a35;
            --green-primary: #2d6a4f;
            --green-mid: #1B7A4E;
            --green-accent: #52b788;
            --green-pale: #d8f3dc;
            --green-tint: #f0faf3;
            --off-white: #fafaf8;
            --ink: #111410;
            --ink-60: #555a50;
            --ink-30: #b0b5aa;
            --border: #e2e8df;
            --red: #d94f4f;
            --red-bg: #fef2f2;
            --amber: #c4880b;
            --amber-bg: #fefce8;
            --blue: #2563eb;
            --blue-bg: #eff6ff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--off-white);
            color: var(--ink);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem 1.5rem;
        }

        .header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--green-primary);
            margin-bottom: 0.25rem;
        }

        .subtitle {
            font-size: 0.85rem;
            color: var(--ink-60);
            font-weight: 500;
        }

        .card {
            width: 100%;
            max-width: 680px;
            background: white;
            border: 1.5px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .card-header {
            padding: 1.25rem 1.75rem;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-header h2 {
            font-size: 0.95rem;
            font-weight: 700;
        }

        .card-header .badge {
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 0.2rem 0.6rem;
            border-radius: 100px;
            background: var(--green-pale);
            color: var(--green-deep);
        }

        .card-body {
            padding: 1.75rem;
        }

        /* Form test section */
        .test-form {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .test-form input {
            flex: 1;
            padding: 0.8rem 1rem;
            border: 1.5px solid var(--border);
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            background: var(--off-white);
            transition: border-color 0.2s;
        }

        .test-form input:focus {
            outline: none;
            border-color: var(--green-primary);
        }

        .test-form button {
            padding: 0.8rem 1.25rem;
            background: var(--green-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.2s;
        }

        .test-form button:hover { background: var(--green-deep); }
        .test-form button:disabled { opacity: 0.6; cursor: not-allowed; }

        .helper-text {
            font-size: 0.78rem;
            color: var(--ink-30);
            margin-bottom: 1.5rem;
        }

        /* Log area */
        .log-area {
            background: #0d1117;
            border-radius: 10px;
            padding: 1.25rem;
            max-height: 420px;
            overflow-y: auto;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.78rem;
            line-height: 1.7;
        }

        .log-entry {
            padding: 0.3rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .log-time { color: #484f58; }
        .log-info { color: #58a6ff; }
        .log-success { color: #3fb950; }
        .log-warn { color: #d29922; }
        .log-error { color: #f85149; }
        .log-detail { color: #8b949e; padding-left: 1.5rem; }

        .log-entry .label {
            display: inline-block;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.1rem 0.4rem;
            border-radius: 3px;
            margin-right: 0.4rem;
        }

        .label-info { background: rgba(88,166,255,0.15); color: #58a6ff; }
        .label-ok { background: rgba(63,185,80,0.15); color: #3fb950; }
        .label-warn { background: rgba(210,153,34,0.15); color: #d29922; }
        .label-fail { background: rgba(248,81,73,0.15); color: #f85149; }
        .label-test { background: rgba(188,143,255,0.15); color: #bc8fff; }

        /* Diagnosis summary */
        .diagnosis {
            margin-top: 1.25rem;
            padding: 1.25rem;
            border-radius: 10px;
            display: none;
        }

        .diagnosis.show { display: block; }

        .diagnosis-success {
            background: var(--green-tint);
            border: 1.5px solid rgba(82,183,136,0.3);
        }

        .diagnosis-fail {
            background: var(--red-bg);
            border: 1.5px solid rgba(217,79,79,0.25);
        }

        .diagnosis-warn {
            background: var(--amber-bg);
            border: 1.5px solid rgba(196,136,11,0.25);
        }

        .diagnosis h3 {
            font-size: 0.9rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .diagnosis p, .diagnosis li {
            font-size: 0.85rem;
            color: var(--ink-60);
            line-height: 1.6;
        }

        .diagnosis ul {
            margin-top: 0.5rem;
            padding-left: 1.25rem;
        }

        .diagnosis li { margin-bottom: 0.25rem; }

        /* Checks list */
        .checks {
            list-style: none;
            margin-top: 0.75rem;
        }

        .checks li {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            padding: 0.5rem 0;
            font-size: 0.85rem;
            color: var(--ink-60);
            border-bottom: 1px solid var(--border);
        }

        .checks li:last-child { border-bottom: none; }

        .check-icon {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            flex-shrink: 0;
        }

        .check-pass { background: var(--green-pale); color: var(--green-primary); }
        .check-fail { background: #fecaca; color: var(--red); }
        .check-wait { background: #f3f4f6; color: var(--ink-30); }

        /* Instructions card */
        .instructions {
            font-size: 0.85rem;
            color: var(--ink-60);
            line-height: 1.7;
        }

        .instructions strong { color: var(--ink); }

        .instructions ol {
            padding-left: 1.25rem;
            margin-top: 0.75rem;
        }

        .instructions li {
            margin-bottom: 0.5rem;
        }

        .instructions code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            background: var(--green-tint);
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
            color: var(--green-deep);
        }

        @media (max-width: 600px) {
            .test-form { flex-direction: column; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">Adworthâ„ </div>
        <div class="subtitle">Waitlist Form Diagnostic Tool</div>
    </div>

    <!-- Instructions -->
    <div class="card">
        <div class="card-header">
            <h2>ðŸ“‹ How to Use</h2>
        </div>
        <div class="card-body instructions">
            <strong>Upload this file to your IONOS hosting</strong> (e.g., at <code>adworth.app/diagnostic.html</code>) and run it from there. Running it from your actual domain is critical â€” it tests whether Cloudflare is interfering with requests from your site.
            <ol>
                <li>Upload this file to your WordPress root or a subfolder</li>
                <li>Visit <code>https://adworth.app/diagnostic.html</code></li>
                <li>Enter a test email and click <strong>Run Diagnostic</strong></li>
                <li>Read the log output and diagnosis below the form</li>
            </ol>
            Running locally or from another domain won't reproduce the issue.
        </div>
    </div>

    <!-- Pre-flight checks -->
    <div class="card">
        <div class="card-header">
            <h2>Pre-Flight Checks</h2>
            <span class="badge" id="preflight-status">Runningâ€¦</span>
        </div>
        <div class="card-body">
            <ul class="checks" id="checks-list">
                <li id="check-https">
                    <span class="check-icon check-wait">â€”</span>
                    Page loaded over HTTPS
                </li>
                <li id="check-domain">
                    <span class="check-icon check-wait">â€”</span>
                    Running on adworth.app domain
                </li>
                <li id="check-cloudflare">
                    <span class="check-icon check-wait">â€”</span>
                    Cloudflare detected
                </li>
                <li id="check-email-obfuscation">
                    <span class="check-icon check-wait">â€”</span>
                    Email obfuscation script absent
                </li>
                <li id="check-fetch">
                    <span class="check-icon check-wait">â€”</span>
                    Fetch API available
                </li>
            </ul>
        </div>
    </div>

    <!-- Form test -->
    <div class="card">
        <div class="card-header">
            <h2>Form Submission Test</h2>
            <span class="badge">Step 2</span>
        </div>
        <div class="card-body">
            <div class="test-form">
                <input type="email" id="test-email" placeholder="test@example.com" value="diagnostic-test@adworth.app">
                <button id="run-btn" onclick="runDiagnostic()">Run Diagnostic</button>
            </div>
            <p class="helper-text">This sends a real submission to your Formspree endpoint and logs every step.</p>

            <div class="log-area" id="log"></div>

            <div class="diagnosis" id="diagnosis"></div>
        </div>
    </div>

    <script>
        const logEl = document.getElementById('log');
        const diagnosisEl = document.getElementById('diagnosis');

        function timestamp() {
            return new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function log(message, type = 'info', detail = null) {
            const labelMap = {
                info: '<span class="label label-info">INFO</span>',
                success: '<span class="label label-ok">OK</span>',
                warn: '<span class="label label-warn">WARN</span>',
                error: '<span class="label label-fail">FAIL</span>',
                test: '<span class="label label-test">TEST</span>',
            };

            const colorMap = {
                info: 'log-info',
                success: 'log-success',
                warn: 'log-warn',
                error: 'log-error',
                test: 'log-info',
            };

            let html = `<div class="log-entry">`;
            html += `<span class="log-time">${timestamp()}</span> `;
            html += `${labelMap[type] || labelMap.info} `;
            html += `<span class="${colorMap[type] || 'log-info'}">${message}</span>`;
            if (detail) {
                html += `<div class="log-detail">${detail}</div>`;
            }
            html += `</div>`;

            logEl.innerHTML += html;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function setCheck(id, pass) {
            const el = document.querySelector(`#${id} .check-icon`);
            el.className = `check-icon ${pass ? 'check-pass' : 'check-fail'}`;
            el.textContent = pass ? 'âœ“' : 'âœ—';
        }

        function showDiagnosis(type, title, html) {
            diagnosisEl.className = `diagnosis show diagnosis-${type}`;
            diagnosisEl.innerHTML = `<h3>${title}</h3>${html}`;
        }

        // â”€â”€ PRE-FLIGHT CHECKS â”€â”€
        (function runPreflight() {
            const isHttps = location.protocol === 'https:';
            setCheck('check-https', isHttps);
            if (!isHttps) log('Page not loaded over HTTPS â€” Formspree may reject requests', 'warn');

            const isAdworth = location.hostname.includes('adworth.app');
            setCheck('check-domain', isAdworth);
            if (!isAdworth) log(`Running on ${location.hostname} â€” run on adworth.app for accurate results`, 'warn');

            // Check for Cloudflare
            const cfScripts = document.querySelectorAll('script[src*="cloudflare"], script[src*="/cdn-cgi/"]');
            const hasCfMeta = !!document.querySelector('meta[name*="cloudflare"]');
            const cfDetected = cfScripts.length > 0 || hasCfMeta || document.cookie.includes('__cf');
            setCheck('check-cloudflare', true); // informational
            log(cfDetected ? 'Cloudflare presence detected on page' : 'No direct Cloudflare markers found (may still be proxied)', 'info');

            // Check email obfuscation
            const emailObfScripts = document.querySelectorAll('script[src*="email-decode"], script[data-cfasync], script[src*="cdn-cgi/scripts/"]');
            const hasEmailObf = emailObfScripts.length > 0 || !!document.querySelector('[data-cfemail]');
            setCheck('check-email-obfuscation', !hasEmailObf);
            if (hasEmailObf) {
                log('Cloudflare Email Obfuscation script detected â€” this INJECTS JS that can break forms', 'error');
            } else {
                log('No Cloudflare email obfuscation detected on this page', 'success');
            }

            const hasFetch = typeof fetch === 'function';
            setCheck('check-fetch', hasFetch);

            document.getElementById('preflight-status').textContent = 'Done';
        })();

        // â”€â”€ MAIN DIAGNOSTIC â”€â”€
        async function runDiagnostic() {
            const btn = document.getElementById('run-btn');
            const email = document.getElementById('test-email').value;

            if (!email) { log('Enter a test email first', 'warn'); return; }

            btn.disabled = true;
            btn.textContent = 'Runningâ€¦';
            logEl.innerHTML = '';
            diagnosisEl.className = 'diagnosis';

            const issues = [];
            const FORMSPREE_URL = 'https://formspree.io/f/mlgwgndk';

            log('Starting waitlist form diagnosticâ€¦', 'test');
            log(`Target endpoint: ${FORMSPREE_URL}`, 'info');
            log(`Test email: ${email}`, 'info');

            // â”€â”€ Test 1: DNS / reachability â”€â”€
            log('Test 1 â€” Can we reach formspree.io at all?', 'test');
            try {
                const pingStart = performance.now();
                const pingRes = await fetch('https://formspree.io', { method: 'HEAD', mode: 'no-cors' });
                const pingMs = Math.round(performance.now() - pingStart);
                log(`formspree.io reachable (${pingMs}ms)`, 'success');
            } catch (e) {
                log(`Cannot reach formspree.io: ${e.message}`, 'error');
                issues.push('network_blocked');
                log('This usually means Cloudflare or a firewall is blocking outbound requests to formspree.io', 'error');
            }

            // â”€â”€ Test 2: OPTIONS preflight â”€â”€
            log('Test 2 â€” CORS preflight check', 'test');
            try {
                const optRes = await fetch(FORMSPREE_URL, {
                    method: 'OPTIONS',
                    headers: {
                        'Origin': location.origin,
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type,Accept',
                    }
                });
                const corsAllow = optRes.headers.get('access-control-allow-origin');
                log(`Preflight response: ${optRes.status}`, optRes.ok ? 'success' : 'warn');
                if (corsAllow) {
                    log(`CORS Allow-Origin: ${corsAllow}`, 'success');
                } else {
                    log('No CORS header in preflight â€” browser may block the POST', 'warn');
                    // Note: opaque responses may hide headers, not necessarily a failure
                }
            } catch (e) {
                log(`Preflight failed: ${e.message}`, 'warn', 'This may be normal if Cloudflare intercepts OPTIONS requests');
            }

            // â”€â”€ Test 3: Actual POST submission â”€â”€
            log('Test 3 â€” Submitting form data to Formspree', 'test');
            try {
                const start = performance.now();
                const res = await fetch(FORMSPREE_URL, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        _source: 'adworth-diagnostic',
                        _timestamp: new Date().toISOString(),
                    })
                });
                const elapsed = Math.round(performance.now() - start);

                log(`Response status: ${res.status} ${res.statusText} (${elapsed}ms)`, res.ok ? 'success' : 'error');

                // Log all response headers we can see
                const headerEntries = [...res.headers.entries()];
                if (headerEntries.length > 0) {
                    log('Response headers:', 'info');
                    headerEntries.forEach(([k, v]) => {
                        log(`  ${k}: ${v}`, 'info');
                    });
                }

                // Check for Cloudflare interception
                const cfRay = res.headers.get('cf-ray');
                const server = res.headers.get('server');
                if (cfRay || (server && server.toLowerCase().includes('cloudflare'))) {
                    log('Response came through Cloudflare (cf-ray header present)', 'warn');
                    issues.push('cloudflare_intercept');
                }

                // Check for Cloudflare challenge page
                const contentType = res.headers.get('content-type') || '';

                let body;
                try {
                    if (contentType.includes('application/json')) {
                        body = await res.json();
                        log(`Response body: ${JSON.stringify(body)}`, res.ok ? 'success' : 'error');

                        if (body.ok) {
                            log('Formspree accepted the submission!', 'success');
                        } else if (body.error) {
                            log(`Formspree error: ${body.error}`, 'error');
                            issues.push('formspree_error');
                        } else if (body.errors) {
                            body.errors.forEach(err => {
                                log(`Formspree validation: ${err.field || ''} ${err.message || JSON.stringify(err)}`, 'error');
                            });
                            issues.push('formspree_validation');
                        }
                    } else {
                        body = await res.text();
                        // Check if it's a Cloudflare challenge/block page
                        if (body.includes('cf-browser-verification') || body.includes('Checking your browser') || body.includes('challenge-platform')) {
                            log('Cloudflare is intercepting the request with a browser challenge!', 'error');
                            issues.push('cloudflare_challenge');
                        } else if (body.includes('cf-error') || body.includes('403 Forbidden') || body.includes('Access denied')) {
                            log('Cloudflare is BLOCKING the request', 'error');
                            issues.push('cloudflare_block');
                        } else if (res.status >= 400) {
                            log(`Non-JSON error response (${body.substring(0, 300)})`, 'error');
                            issues.push('unexpected_error');
                        } else {
                            log(`Unexpected content-type: ${contentType}`, 'warn');
                            log(`Body preview: ${body.substring(0, 300)}`, 'info');
                        }
                    }
                } catch (parseErr) {
                    log(`Could not parse response: ${parseErr.message}`, 'warn');
                }

                if (res.status === 0) {
                    log('Status 0 â€” request was likely blocked by CORS or Cloudflare', 'error');
                    issues.push('cors_or_block');
                } else if (res.status === 403) {
                    log('403 Forbidden â€” Cloudflare WAF or Formspree is rejecting the request', 'error');
                    issues.push('forbidden');
                } else if (res.status === 429) {
                    log('429 Rate Limited â€” too many requests to Formspree', 'error');
                    issues.push('rate_limited');
                }

            } catch (fetchErr) {
                log(`Fetch threw an exception: ${fetchErr.message}`, 'error');
                log(`Error type: ${fetchErr.name}`, 'error');

                if (fetchErr.message.includes('Failed to fetch') || fetchErr.message.includes('NetworkError')) {
                    log('This is a network-level block â€” most likely Cloudflare WAF or CSP', 'error');
                    issues.push('network_block');
                } else if (fetchErr.message.includes('CORS')) {
                    log('CORS error â€” Formspree is not allowing requests from this origin', 'error');
                    issues.push('cors_error');
                }

                issues.push('fetch_exception');
            }

            // â”€â”€ Test 4: Check for CSP headers â”€â”€
            log('Test 4 â€” Content Security Policy check', 'test');
            try {
                // Check if there's a CSP meta tag blocking connect-src
                const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
                if (cspMeta) {
                    const csp = cspMeta.getAttribute('content');
                    log(`CSP meta tag found: ${csp}`, 'warn');
                    if (csp && !csp.includes('formspree.io') && csp.includes('connect-src')) {
                        log('CSP connect-src does NOT include formspree.io â€” this blocks the request!', 'error');
                        issues.push('csp_block');
                    }
                } else {
                    log('No CSP meta tag found (CSP may be in HTTP headers â€” check Cloudflare settings)', 'info');
                }
            } catch (e) {
                log(`CSP check error: ${e.message}`, 'warn');
            }

            // â”€â”€ Test 5: Cloudflare script injection check â”€â”€
            log('Test 5 â€” Checking for Cloudflare script injection', 'test');
            const allScripts = document.querySelectorAll('script');
            let cfScriptCount = 0;
            allScripts.forEach(s => {
                const src = s.src || '';
                if (src.includes('cdn-cgi') || src.includes('cloudflare') || src.includes('cf-beacon')) {
                    log(`Cloudflare injected script: ${src || '(inline)'}`, 'warn');
                    cfScriptCount++;
                }
            });
            if (cfScriptCount === 0) {
                log('No Cloudflare-injected scripts found on this page', 'success');
            } else {
                log(`${cfScriptCount} Cloudflare script(s) injected â€” these can interfere with form JS`, 'warn');
            }

            // â”€â”€ DIAGNOSIS â”€â”€
            log('â”€â”€â”€â”€â”€ Diagnosis complete â”€â”€â”€â”€â”€', 'test');

            if (issues.length === 0) {
                showDiagnosis('success', 'âœ“ Form submission worked!',
                    `<p>The Formspree endpoint accepted the request from this domain. If the form still doesn't work on your homepage, the issue is likely in the form's JavaScript handler â€” not a network or Cloudflare problem.</p>
                    <ul>
                        <li>Check for JS errors on the homepage (DevTools â†’ Console)</li>
                        <li>Make sure the form handler isn't being overwritten by a WordPress plugin</li>
                        <li>Verify the Formspree endpoint ID matches: <strong>mlgwgndk</strong></li>
                    </ul>`
                );
            } else if (issues.includes('cloudflare_challenge') || issues.includes('cloudflare_block')) {
                showDiagnosis('fail', 'âœ— Cloudflare is blocking the form submission',
                    `<p>Cloudflare's security features are intercepting the POST request to Formspree. Here's how to fix it:</p>
                    <ul>
                        <li><strong>Cloudflare Dashboard â†’ Security â†’ WAF:</strong> Add a rule to allow POST requests to <code>formspree.io</code></li>
                        <li><strong>Cloudflare Dashboard â†’ Scrape Shield:</strong> Turn off "Email Address Obfuscation"</li>
                        <li><strong>Cloudflare Dashboard â†’ Security â†’ Settings:</strong> Check your Security Level â€” "I'm Under Attack" mode blocks API calls</li>
                        <li><strong>Alternative fix:</strong> Switch the form to use Formspree's <code>&lt;form action="..."&gt;</code> method (no JS) as a workaround</li>
                    </ul>`
                );
            } else if (issues.includes('network_block') || issues.includes('network_blocked') || issues.includes('cors_or_block')) {
                showDiagnosis('fail', 'âœ— Network-level block detected',
                    `<p>Requests to formspree.io are being blocked at the network level. This is most likely Cloudflare's WAF or a Content Security Policy header.</p>
                    <ul>
                        <li><strong>Cloudflare Dashboard â†’ Security â†’ WAF:</strong> Check for rules blocking external API calls</li>
                        <li><strong>Cloudflare Dashboard â†’ Rules â†’ Transform Rules:</strong> Check for CSP headers that restrict <code>connect-src</code></li>
                        <li><strong>Quick test:</strong> Temporarily set Cloudflare to DNS-only mode (gray cloud) and re-test</li>
                    </ul>`
                );
            } else if (issues.includes('formspree_error') || issues.includes('formspree_validation')) {
                showDiagnosis('warn', 'âš  Formspree rejected the submission',
                    `<p>The request reached Formspree but was rejected. This is a Formspree configuration issue, not Cloudflare.</p>
                    <ul>
                        <li>Log into <a href="https://formspree.io" target="_blank">formspree.io</a> and check form <strong>mlgwgndk</strong></li>
                        <li>Verify the form is active and hasn't hit submission limits</li>
                        <li>Check if your domain is verified/allowed in Formspree settings</li>
                    </ul>`
                );
            } else if (issues.includes('rate_limited')) {
                showDiagnosis('warn', 'âš  Rate limited by Formspree',
                    `<p>You've hit Formspree's submission limit. Free tier allows 50 submissions/month.</p>
                    <ul>
                        <li>Check your Formspree dashboard for current usage</li>
                        <li>Consider upgrading to a paid plan if you're getting real signups</li>
                    </ul>`
                );
            } else if (issues.includes('forbidden')) {
                showDiagnosis('fail', 'âœ— 403 Forbidden',
                    `<p>The request was explicitly forbidden. Could be Cloudflare WAF or Formspree rejecting your domain.</p>
                    <ul>
                        <li>Check Cloudflare WAF logs for blocked requests</li>
                        <li>In Formspree, check if <code>adworth.app</code> is in the allowed origins</li>
                        <li>Try temporarily disabling Cloudflare proxy (DNS only) to isolate the issue</li>
                    </ul>`
                );
            } else {
                showDiagnosis('warn', 'âš  Inconclusive â€” check the logs above',
                    `<p>Something went wrong but the exact cause isn't clear. The log output above should help narrow it down. Common next steps:</p>
                    <ul>
                        <li>Check Cloudflare Firewall Events (Security â†’ Events) for blocked requests</li>
                        <li>Temporarily bypass Cloudflare (gray cloud the DNS record) and re-run</li>
                        <li>Check browser DevTools on your main homepage for JS errors</li>
                    </ul>`
                );
            }

            btn.disabled = false;
            btn.textContent = 'Run Again';
        }
    </script>

</body>
</html>
